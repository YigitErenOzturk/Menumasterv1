<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurant Details - MenuMaster</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/x-icon" href="../assets/logo/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #fff7ed; }
    ::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #f97316; }
    .rating > input { display: none; }
    .rating > label:before { content: "\2605"; font-size: 2em; cursor: pointer; }
    .rating > label { color: #d1d5db; float: right; transition: color 0.2s; }
    .rating > input:checked ~ label,
    .rating:not(:checked) > label:hover,
    .rating:not(:checked) > label:hover ~ label { color: #f59e0b; }

    .map-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background-color: #f3f4f6;
    }
    .map-container iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
  </style>
</head>

<body class="bg-orange-50 text-gray-800 min-h-screen flex flex-col selection:bg-orange-200 selection:text-orange-900">

  <nav class="bg-white shadow-md sticky top-0 z-20 border-b border-orange-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="../commonfiles/main-page.html" class="text-2xl font-extrabold text-orange-600">Menu<span class="text-gray-800">Master</span></a>
        <a href="../userfiles/dashboard-preview.html" class="text-gray-500 hover:bg-orange-50 hover:text-orange-600 px-3 py-2 rounded-md text-sm font-medium transition flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
          Back to Dashboard
        </a>
      </div>
    </div>
  </nav>

  <div id="main-content" class="max-w-7xl mx-auto p-4 md:p-8 flex-grow w-full">
    <div id="loading-indicator" class="flex flex-col items-center justify-center mt-20">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-orange-500 border-t-transparent mb-4"></div>
      <p class="text-gray-500 text-lg font-medium">Loading restaurant details...</p>
    </div>
  </div>

  <footer class="text-center py-8 border-t border-orange-200 bg-white mt-auto">
    <p class="text-gray-500 text-sm">¬© 2026 MenuMaster - Restaurant Booking System. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE_URL = 'http://localhost:5000/api';

    const mainContentEl = document.getElementById('main-content');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- Auth helpers ---
    const getAuthToken = () => localStorage.getItem('authToken') || localStorage.getItem('token');
    const getCurrentUserId = () => {
      const id = localStorage.getItem('userId');
      return id ? parseInt(id) : null;
    };

    // --- Utility Functions ---
    const getRestaurantIdFromURL = () => {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    };

    const escapeHtml = (text) => {
      if (!text) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const fetchData = async (endpoint, options = {}) => {
      const url = `${API_BASE_URL}/${endpoint}`;
      const authToken = getAuthToken();

      const headers = {
        'Content-Type': 'application/json',
        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
      };

      try {
        const response = await fetch(url, { headers, ...options });

        // 401 user-friendly
        if (response.status === 401) {
          return { error: true, message: 'Unauthorized. Please login.' };
        }

        if (!response.ok) {
          let msg = `HTTP Error! Status: ${response.status}`;
          try {
            const err = await response.json();
            msg = err?.message || msg;
          } catch (_) {}
          throw new Error(msg);
        }

        // DELETE bazen bo≈ü d√∂nebilir, g√ºvenli parse:
        const text = await response.text();
        return text ? JSON.parse(text) : { ok: true };

      } catch (error) {
        console.error("API Fetch Error:", error);
        return { error: true, message: error.message };
      }
    };

    const fetchMenu = async (restaurantId) => {
      const data = await fetchData(`restaurants/menu/${restaurantId}`);
      return data.error ? [] : (data.menu || []);
    };

    const fetchReviews = async (restaurantId) => {
      const data = await fetchData(`reviews/restaurant/${restaurantId}`);

      if (data?.error) return [];

      // backend: return Ok(new { reviews }) ise:
      if (Array.isArray(data?.reviews)) return data.reviews;

      // backend direkt array d√∂nd√ºrd√ºyse:
      if (Array.isArray(data)) return data;

      return [];
    };

    const createStarSvg = (rating, index, size = "w-6 h-6") => {
      const colorClass = index < Math.round(rating || 0) ? 'text-yellow-500' : 'text-gray-300';
      return `<svg class="${size} ${colorClass}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
    };

    const renderReviewsHtml = (reviews) => {
      if (!Array.isArray(reviews) || reviews.length === 0) {
        return '<p class="text-gray-500 italic">No reviews yet. Be the first to review!</p>';
      }

      return reviews.map(review => {
        const reviewStars = Array(5).fill(0).map((_, i) => createStarSvg(review.rating, i, "w-4 h-4")).join('');
        const dateText = review.date ? new Date(review.date).toLocaleDateString() : '';
        return `
          <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-gray-800">${escapeHtml(review.userName || 'Anonymous')}</span>
              <div class="flex">${reviewStars}</div>
            </div>
            <p class="text-gray-600 text-sm">${escapeHtml(review.comment)}</p>
            <p class="text-xs text-gray-400 mt-2 text-right">${dateText}</p>
          </div>
        `;
      }).join('');
    };

    const renderPage = (data) => {
      const stars = Array(5).fill(0).map((_, i) => createStarSvg(data.rating, i)).join('');
      const menuItems = Array.isArray(data.menu) ? data.menu : [];
      const reviews = Array.isArray(data.reviews) ? data.reviews : [];

      // IMPORTANT: review.userId bekliyoruz (backend ReviewViewDto'ya UserId eklemelisin)
      const currentUserId = getCurrentUserId();
      const isLoggedIn = !!getAuthToken();

      const myReview = (isLoggedIn && currentUserId)
        ? reviews.find(r => r.userId === currentUserId)
        : null;

      // --- Menu Logic ---
      const groupedMenu = menuItems.reduce((acc, item) => {
        const cat = item.category || 'General';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(item);
        return acc;
      }, {});

      const menuHtml = Object.keys(groupedMenu).length === 0
        ? '<p class="text-gray-500 italic">No menu items available.</p>'
        : Object.entries(groupedMenu).map(([category, items]) => `
          <div class="mb-6">
            <h3 class="text-lg font-bold text-orange-600 border-b border-orange-200 mb-3 uppercase tracking-wide">${escapeHtml(category)}</h3>
            <div class="space-y-4">
              ${items.map(item => `
                <div class="flex justify-between items-start group">
                  <div class="flex-grow pr-4">
                    <div class="flex items-center">
                      <span class="text-gray-800 font-semibold group-hover:text-orange-600 transition-colors">${escapeHtml(item.name)}</span>
                      <div class="flex-grow border-b border-dotted border-gray-300 mx-2 mb-1"></div>
                    </div>
                    <p class="text-xs text-gray-500 italic mt-0.5">${escapeHtml(item.description || 'No description available.')}</p>
                  </div>
                  <span class="font-bold text-orange-700 whitespace-nowrap">${item.price} PLN</span>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');

      const reviewsHtml = renderReviewsHtml(reviews);

      // --- Add review block (user-friendly) ---
      const addReviewBlockHtml = !isLoggedIn
        ? `
          <div class="mb-8 bg-orange-50 p-4 rounded-xl border border-orange-200">
            <p class="text-gray-700 font-medium">
              Please <a class="text-orange-700 font-bold underline" href="../commonfiles/login.html">log in</a> to write a review.
            </p>
          </div>
        `
        : (myReview
          ? `
            <div class="mb-8 bg-green-50 p-4 rounded-xl border border-green-200">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>
                  <h3 class="font-bold text-lg text-green-800">You already reviewed this restaurant</h3>
                  <p class="text-sm text-green-700 mt-1">
                    ‚≠ê ${myReview.rating} ‚Äî ‚Äú${escapeHtml(myReview.comment)}‚Äù
                  </p>
                </div>

                <div class="flex gap-2">
                  <button id="edit-my-review-btn"
                    class="px-3 py-2 rounded-lg bg-orange-600 text-white font-medium hover:bg-orange-700 transition">
                    Edit
                  </button>
                  <button id="delete-my-review-btn"
                    class="px-3 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition">
                    Delete
                  </button>
                </div>
              </div>
              <p id="my-review-message" class="text-sm mt-2"></p>
            </div>
          `
          : `
            <div class="mb-8 bg-orange-50 p-4 rounded-xl border border-orange-200">
              <h3 class="font-bold text-lg mb-3">Write a Review</h3>
              <form id="review-form" class="space-y-3">
                <div class="rating flex flex-row-reverse justify-end gap-1">
                  <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars"></label>
                  <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars"></label>
                  <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars"></label>
                  <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars"></label>
                  <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star"></label>
                </div>
                <textarea id="review-comment" placeholder="Share your experience..."
                  class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-orange-500 bg-white"
                  rows="3" required></textarea>
                <button type="submit"
                  class="bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700 transition">
                  Submit Review
                </button>
                <p id="review-message" class="text-sm mt-1"></p>
              </form>
            </div>
          `
        );

      // --- Map Logic ---
      const mapAddress = encodeURIComponent(data.address || '');
      const mapSrc = `https://maps.google.com/maps?q=${mapAddress}&t=&z=15&ie=UTF8&iwloc=&output=embed`;

      mainContentEl.innerHTML = `
        <header class="relative rounded-2xl overflow-hidden mb-8 shadow-xl border border-gray-200">
          <img src="${data.imageUrl || ('https://placehold.co/1200x400/ea580c/ffffff?text=' + encodeURIComponent(data.name || 'Restaurant'))}"
               alt="${escapeHtml(data.name || 'Restaurant')}" class="w-full h-48 md:h-72 object-cover">
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-6 md:p-10">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white drop-shadow-md">${escapeHtml(data.name || 'Restaurant')}</h1>
            <div class="flex items-center mt-3">${stars}</div>
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-8">
            <section class="bg-white p-6 rounded-2xl shadow-lg border border-orange-100">
              <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b-2 border-orange-500 pb-2 inline-block">Menu</h2>
              <div id="menu-container">${menuHtml}</div>
            </section>

            <section class="bg-white p-6 rounded-2xl shadow-lg border border-orange-100">
              <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-orange-500 pb-2 inline-block">Reviews</h2>

              ${addReviewBlockHtml}

              <div id="reviews-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                ${reviewsHtml}
              </div>
            </section>
          </div>

          <div class="lg:col-span-1 space-y-8">
            <aside class="bg-white p-6 rounded-2xl shadow-lg border border-orange-100 sticky top-24">
              <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b-2 border-orange-500 pb-2 inline-block">Contact & Info</h2>

              <div class="map-container shadow-inner border border-gray-200">
                <iframe src="${mapSrc}" allowfullscreen="" loading="lazy"></iframe>
              </div>

              <ul class="space-y-4 text-gray-600">
                <li class="flex items-start"><span class="font-medium">üìç ${escapeHtml(data.address || 'Address not listed')}</span></li>
                <li class="flex items-center"><span class="font-medium">üìû ${escapeHtml(data.phoneNumber || 'N/A')}</span></li>
              </ul>
            </aside>

            <aside class="bg-orange-100/50 p-6 rounded-2xl shadow-lg border-2 border-orange-300">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Make a Reservation</h2>
              <form id="reservation-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Number of People</label>
                  <input type="number" id="people" value="2" min="1"
                         class="w-full p-3 border border-orange-200 rounded-xl outline-none" required>
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Date</label>
                  <input type="date" id="date"
                         class="w-full p-3 border border-orange-200 rounded-xl outline-none" required>
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Time</label>
                  <input type="time" id="time"
                         class="w-full p-3 border border-orange-200 rounded-xl outline-none" required>
                </div>
                <button type="submit"
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl transition shadow-md">
                  Book a Table
                </button>
                <p id="form-message" class="text-center mt-2 h-5 font-medium"></p>
              </form>
            </aside>
          </div>
        </div>
      `;

      // listeners
      document.getElementById('reservation-form')?.addEventListener('submit', handleReservationSubmit);

      const reviewForm = document.getElementById('review-form');
      if (reviewForm) reviewForm.addEventListener('submit', handleReviewSubmit);

      const editBtn = document.getElementById('edit-my-review-btn');
      if (editBtn && myReview) editBtn.addEventListener('click', () => openEditReviewPrompt(myReview));

      const delBtn = document.getElementById('delete-my-review-btn');
      if (delBtn && myReview) delBtn.addEventListener('click', () => deleteMyReview(myReview.id));
    };

    const handleReservationSubmit = async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById('form-message');
      msgEl.textContent = 'Submitting...';
      msgEl.className = 'text-center mt-2 h-5 font-medium text-gray-500';

      const rawId = getRestaurantIdFromURL();
      const resId = parseInt(rawId);

      if (isNaN(resId)) {
        msgEl.textContent = 'Error: Invalid Restaurant ID';
        msgEl.className = 'text-center mt-2 text-red-600 font-bold';
        return;
      }

      const reservationData = {
        restaurantId: resId,
        people: parseInt(document.getElementById('people').value),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value
      };

      const result = await fetchData('reservations', {
        method: 'POST',
        body: JSON.stringify(reservationData)
      });

      if (!result.error) {
        msgEl.textContent = 'Reservation successful! Redirecting...';
        msgEl.className = 'text-center mt-2 text-green-600 font-bold';
        setTimeout(() => {
          window.location.href = '../userfiles/dashboard-preview.html?section=reservations';
        }, 2000);
      } else {
        msgEl.textContent = 'Error: ' + (result.message || 'Submission failed');
        msgEl.className = 'text-center mt-2 text-red-600 font-bold';
      }
    };

    const handleReviewSubmit = async (e) => {
      e.preventDefault();

      const token = getAuthToken();
      const msgEl = document.getElementById('review-message');

      if (!token) {
        msgEl.textContent = 'Please login to post a review.';
        msgEl.className = 'text-sm mt-1 text-red-600 font-bold';
        return;
      }

      msgEl.textContent = 'Posting...';
      msgEl.className = 'text-sm mt-1 text-gray-500';

      const rawId = getRestaurantIdFromURL();
      const restaurantId = parseInt(rawId);

      if (isNaN(restaurantId)) {
        msgEl.textContent = 'Error: Invalid Restaurant ID';
        msgEl.className = 'text-sm mt-1 text-red-600 font-bold';
        return;
      }

      const ratingInput = document.querySelector('input[name="rating"]:checked');
      if (!ratingInput) {
        msgEl.textContent = 'Please select a star rating.';
        msgEl.className = 'text-sm mt-1 text-red-500 font-bold';
        return;
      }

      const comment = document.getElementById('review-comment').value.trim();
      if (!comment) {
        msgEl.textContent = 'Please write a comment.';
        msgEl.className = 'text-sm mt-1 text-red-500 font-bold';
        return;
      }

      const reviewData = {
        restaurantId,
        rating: parseInt(ratingInput.value),
        comment
      };

      const result = await fetchData('reviews', {
        method: 'POST',
        body: JSON.stringify(reviewData)
      });

      if (!result.error) {
        msgEl.textContent = 'Review added successfully!';
        msgEl.className = 'text-sm mt-1 text-green-600 font-bold';
        setTimeout(() => window.location.reload(), 800);
      } else {
        // backend ‚Äúalready reviewed‚Äù gibi mesaj d√∂nd√ºr√ºyorsa burada g√∂ster
        msgEl.textContent = 'Error: ' + (result.message || 'Failed to post review');
        msgEl.className = 'text-sm mt-1 text-red-600 font-bold';
      }
    };

    const deleteMyReview = async (reviewId) => {
      if (!confirm('Delete your review?')) return;

      const msgEl = document.getElementById('my-review-message');
      msgEl.textContent = 'Deleting...';
      msgEl.className = 'text-sm mt-2 text-gray-500';

      const result = await fetchData(`reviews/${reviewId}`, { method: 'DELETE' });

      if (!result.error) {
        msgEl.textContent = 'Deleted! Refreshing...';
        msgEl.className = 'text-sm mt-2 text-green-700 font-bold';
        setTimeout(() => window.location.reload(), 600);
      } else {
        msgEl.textContent = 'Error: ' + (result.message || 'Failed');
        msgEl.className = 'text-sm mt-2 text-red-600 font-bold';
      }
    };

    const openEditReviewPrompt = async (myReview) => {
      const msgEl = document.getElementById('my-review-message');

      const newRatingStr = prompt('New rating (1-5):', String(myReview.rating));
      if (newRatingStr === null) return;
      const newRating = parseInt(newRatingStr);

      if (isNaN(newRating) || newRating < 1 || newRating > 5) {
        alert('Rating must be between 1 and 5');
        return;
      }

      const newComment = prompt('New comment:', myReview.comment || '');
      if (newComment === null) return;

      if (!newComment.trim()) {
        alert('Comment cannot be empty');
        return;
      }

      msgEl.textContent = 'Updating...';
      msgEl.className = 'text-sm mt-2 text-gray-500';

      const result = await fetchData(`reviews/${myReview.id}`, {
        method: 'PUT',
        body: JSON.stringify({ rating: newRating, comment: newComment.trim() })
      });

      if (!result.error) {
        msgEl.textContent = 'Updated! Refreshing...';
        msgEl.className = 'text-sm mt-2 text-green-700 font-bold';
        setTimeout(() => window.location.reload(), 600);
      } else {
        msgEl.textContent = 'Error: ' + (result.message || 'Failed');
        msgEl.className = 'text-sm mt-2 text-red-600 font-bold';
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const restaurantId = getRestaurantIdFromURL();
      if (!restaurantId) {
        mainContentEl.innerHTML = `<p class="text-center text-red-500 font-bold mt-10">Error: No restaurant selected.</p>`;
        return;
      }

      const [restaurantData, menuItems, reviewsData] = await Promise.all([
        fetchData(`restaurants/${restaurantId}`),
        fetchMenu(restaurantId),
        fetchReviews(restaurantId)
      ]);

      if (loadingIndicator) loadingIndicator.style.display = 'none';

      renderPage({
        ...restaurantData,
        menu: menuItems,
        reviews: reviewsData
      });
    });
  </script>
</body>
</html>
